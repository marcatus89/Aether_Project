@inherits LayoutComponentBase
@using MudBlazor
@using System.Security.Claims
@using SanitaryWareECommerce.Application.Interfaces

@implements IDisposable

@inject IShoppingCartService ShoppingCartService

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="2" Dense="true" Fixed="true" Class="custom-appbar" Color="Color.Dark">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
            OnClick="@DrawerToggle" Class="d-lg-none" />
        <MudLink Href="/" Typo="Typo.h5" Color="Color.Inherit" Underline="Underline.None" Class="site-logo mx-3">
            <i class="fa-solid fa-gem me-2" style="color: white;"></i>
            AETHER
        </MudLink>
        <MudSpacer />
        <div class="d-none d-lg-flex align-center gap-4">
            <MudNavLink Href="/products" Color="Color.Inherit">Product</MudNavLink>
            <MudNavLink Href="/services" Color="Color.Inherit">Services</MudNavLink>
            <MudNavLink Href="/projects" Color="Color.Inherit">Projects</MudNavLink>
            <MudNavLink Href="/story" Color="Color.Inherit">Stories</MudNavLink>
            <MudNavLink Href="/blog" Color="Color.Inherit">News</MudNavLink>
            <MudNavLink Href="/contact" Color="Color.Inherit">Contact</MudNavLink>
        </div>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Outlined.Search" Color="Color.Inherit" Class="mx-1" />
        <MudBadge Content="@_cartItemCount" Color="Color.Secondary" Overlap="true" Class="mx-3" Visible="@(_cartItemCount > 0)">
            <MudIcon Icon="@Icons.Material.Outlined.ShoppingCart" Color="Color.Inherit" />
        </MudBadge>
        <LoginDisplay />
    </MudAppBar>
    
    <MudDrawer @bind-Open="_drawerOpen" Anchor="Anchor.Left" Elevation="1" Variant="@DrawerVariant.Temporary">
        <MudNavMenu>
            <MudNavLink Href="/products">Product</MudNavLink>
            <MudNavLink Href="/services">Services</MudNavLink>
            <MudNavLink Href="/projects">Projects</MudNavLink>
            <MudNavLink Href="/story">Stories</MudNavLink>
            <MudNavLink Href="/blog">News</MudNavLink>
            <MudNavLink Href="/contact">Contact</MudNavLink>
            <MudDivider />
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent Class="pa-0">
        @Body
    </MudMainContent>

    <!-- FOOTER -->
    <footer class="site-footer" style="background-color:#424242; color:white; padding:4rem 0;">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge">
            <MudGrid Spacing="6">
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.h6" Class="footer-title">AETHER</MudText>
                    <MudText Typo="Typo.body2">
                        Creating luxurious living spaces with high-end sanitary equipment, crafted with precision and elegance in every detail.
                    </MudText>
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudText Typo="Typo.h6" Class="footer-title">Links</MudText>
                    <div class="footer-links">
                        <MudLink Href="/" Class="footer-link">Home</MudLink>
                        <MudLink Href="/products" Class="footer-link">Products</MudLink>
                        <MudLink Href="/contact" Class="footer-link">Contact</MudLink>
                    </div>
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudText Typo="Typo.h6" Class="footer-title">Policies</MudText>
                    <div class="footer-links">
                        <MudLink Href="/policy/shipping" Class="footer-link">Shipping</MudLink>
                        <MudLink Href="/policy/warranty" Class="footer-link">Warranty</MudLink>
                    </div>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.h6" Class="footer-title">Subscribe</MudText>
                    <MudTextField T="string" Label="Your Email" Variant="Variant.Outlined" Class="w-100 mb-2" />
                    <MudButton Color="Color.Secondary" Variant="Variant.Filled">Subscribe</MudButton>
                </MudItem>
            </MudGrid>
            <MudDivider Class="my-6" Style="border-color:#333;" />
            <MudText Typo="Typo.caption" Align="Align.Center">
                © @DateTime.Now.Year Aether. All Rights Reserved.
            </MudText>
        </MudContainer>
    </footer>
</MudLayout>

@code {
    private int _cartItemCount = 0;
    private bool _drawerOpen = false;
    private bool _isDarkMode = false;
    private MudThemeProvider _mudThemeProvider = null!;
    private MudTheme _theme = new();

    protected override async Task OnInitializedAsync()
    {
        ShoppingCartService.OnCartChanged += HandleCartChanged;
        await UpdateCartCount();
    }

    private async void HandleCartChanged()
    {
        await InvokeAsync(UpdateCartCount);
    }

    private async Task UpdateCartCount()
    {
        _cartItemCount = await ShoppingCartService.GetCartItemCountAsync();
        StateHasChanged();
    }

    public void Dispose()
    {
        ShoppingCartService.OnCartChanged -= HandleCartChanged;
    }

    void DrawerToggle() => _drawerOpen = !_drawerOpen;
}

